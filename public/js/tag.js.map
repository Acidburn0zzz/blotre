{"version":3,"sources":["tag.js"],"names":[],"mappings":"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","file":"tag.js","sourcesContent":["require([\n    './models',\n    './stream_manager',\n    './application_model',\n    './shared'],\nfunction(\n    models,\n    stream_manager,\n    application_model,\n    shared)\n{\n\"use-strict\";\n\n/**\n*/\nvar TagViewModel = function(tag, user, results) {\n    var self = this;\n    application_model.AppViewModel.call(this, user);\n\n    self.tag = ko.observable(tag);\n    self.user = ko.observable(user);\n    self.children = ko.observable(new models.Collection(tag));\n    self.query = ko.observable(undefined);\n\n    self.addChild = function(child) {\n        self.children().addChild(child);\n    };\n\n    self.removeChild = function(childUri) {\n        return self.children().children.remove(function(x) {\n             return x.uri() === childUri;\n         });\n    };\n};\n\nvar normalizeQuery = function(query) {\n    return decodeURI(query).replace(/\\+/g, ' ').trim();\n};\n\nvar updateSearchResultsForQuery = function(model, query) {\n    query = normalizeQuery(query);\n    $('.list-loading').removeClass('hidden');\n    $.ajax({\n        type: \"GET\",\n        url: jsRoutes.controllers.StreamApiController.getTagChildren(model.tag()).url,\n        data: {\n            'query': query\n        },\n        headers: {\n            accept: \"application/json\"\n        },\n        error: function() {\n            $('.list-loading').addClass('hidden');\n            // todo: display error msg\n        }\n    }).done(function(result) {\n        $('.list-loading').addClass('hidden');\n        model.query(query);\n        model.children().children((result || []).map(models.StreamModel.fromJson));\n    });\n};\n\nvar updateSearchResults = function(model) {\n    return updateSearchResultsForQuery(\n        model,\n        normalizeQuery($('#stream-search-form input').val()));\n};\n\nvar getQueryFromQueryString = function() {\n    var qs = shared.getQueryString().query;\n    return (qs ? normalizeQuery(qs[0]) : '');\n};\n\nvar updateFromQueryString = function(model) {\n    var query = getQueryFromQueryString();\n    $('#stream-search-form input').val(query);\n    updateSearchResultsForQuery(model, query);\n};\n\n$(function(){\n    var model = new TagViewModel(\n        window.initialTag.tag,\n        application_model.initialUser(),\n        []);\n\n    $('#stream-search-form button').click(function(e) {\n        e.preventDefault();\n        updateSearchResults(model);\n    });\n\n    $('#stream-search-form input').keypress(function(e) {\n        if (e.keyCode === 13) {\n            updateSearchResults(model);\n            e.preventDefault();\n        }\n    });\n\n    model.children().children.subscribe(function(results) {\n        if (results.length)\n            $('.no-results').addClass('hidden');\n        else\n            $('.no-results').removeClass('hidden');\n    });\n\n    model.query.subscribe(function(query) {\n        var currentQuery = (window.history.state ? window.history.state.query : undefined);\n        if (query === currentQuery)\n            return;\n        var path = window.location.origin + window.location.pathname;\n        var url = (query ? path + \"?query=\" + encodeURIComponent(query) : path);\n        window.history.pushState({ query: query }, '', url);\n    });\n\n    model.manager.subscribeCollection('#' + model.tag(), {\n       'StatusUpdated': function(msg) {\n           var existingChild = model.removeChild(msg.from);\n           if (existingChild.length) {\n               existingChild[0].status(models.StatusModel.fromJson(msg.status));\n               model.addChild(existingChild[0]);\n           }\n       },\n       'ChildAdded': function(msg) {\n           model.addChild(models.StreamModel.fromJson(msg.child));\n       },\n       'ChildRemoved': function(msg) {\n           model.removeChild(msg.child);\n       }\n    });\n\n    window.onpopstate = function(e) {\n        updateFromQueryString(model);\n    };\n\n    window.history.replaceState({ query: getQueryFromQueryString() }, '', window.location.href);\n\n    updateFromQueryString(model);\n\n    ko.applyBindings(model);\n});\n\n});"],"sourceRoot":"/source/"}